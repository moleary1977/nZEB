<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title>Train to NZEB</title>

    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/mdb.min.css" rel="stylesheet">
    <link href="./css/styles.css" rel="stylesheet">

</head>

<body class="container ">
<!-- test -->
    <input type="hidden" id="subtitles_on_page">

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a id="menu_home" href="./index.html"></a>
        <a id="menu_about" href="./about.html"></a>
        <a id="menu_training" href="./training-hub.html"></a>
        <a id="menu_search" href="./search.html"></a>
        <a id="menu_links" href="./links.html"></a>
        <a id="logout" href="./index.html"></a>
    </div>

    <div class="row">

        <div class="card-panel menu-top">
            <div class="col-xs-2 menu-icon" onclick="openNav()">&#9776;</div>
            <div class="col-xs-8"><a href="./index.html"><img src="./res/img/train-to-nzeb.png" alt="NZEB"/></a></div>
            <div class="col-xs-2 profile"><a href="./profile.html"><img src="./res/img/profile.png" alt="Go to profile"/></a></div>
        </div>

        <img src="./res/img/nzeb-bg.png" alt="NZEB Background Image" />

        <div class="nav-menu">
            <div class="card-panel col-sm-12 nav">
                <img src="./res/icons/info.png"> 
                <a id="front_menu_about" class="menu_about" href="./about.html"></a><br>
                <span id="subtitle_about" class="subtitle"></span>
            </div>
            <div class="card-panel col-sm-12 nav">
                <img src="./res/icons/blackboard.png"> 
                <a id="front_menu_training" class="menu_training" href="./training-hub.html"></a><br>
                <span id="subtitle_training" class="subtitle"></span>
            </div>
            <div class="card-panel col-sm-12 nav">
                <img src="./res/icons/group.png"> 
                <a id="front_menu_search" class="menu_search" href="./search.html"></a><br>
                <span id="subtitle_search" class="subtitle"></span>
            </div>
            <div class="card-panel col-sm-12 nav">
                <img src="./res/icons/link.png"> 
                <a id="front_menu_links" class="menu_links" href="./links.html"></a><br>
                <span id="subtitle_links" class="subtitle"></span>
            </div>
            <div id="menu_bottom" class="card-panel amber col-sm-12 nav-bottom"><a href="./training-content.html"></a></div>
        </div>

    </div>

    <script type="text/javascript" src="cordova.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/mdb.min.js"></script>
    <script type="text/javascript" src="./js/functions.js"></script>
    <script type="text/javascript" src="language.js"></script>

    <script type="text/javascript">

        jQuery(document).ready(function(){

            // if the cookie exists, the user is logged in
            if(document.cookie){
                console.log("Cookie");
                // TODO? - get_user_meta user's name for welcome message after logging in

            // if the cookie does not exist, the user must log in
            } else if(!document.cookie){
                console.log("No cookie");

                // hide items only to be seen when logged in
                jQuery(".nav-menu").children().hide();
                jQuery(".menu-icon").text("");
                jQuery(".profile a").hide();

                // Login User form
                jQuery(".nav-menu").append('<div class="card-panel login"></div>');
                jQuery("div.login")
                    .append('<h1>Login</h1><hr>')
                    .append('<input type="text" name="username" id="username" placeholder="Enter your username..." />')
                    .append('<label for="username">Username</label>')
                    .append('<input type="password" name="password" id="password" placeholder="Enter your password..." />')
                    .append('<label for="password">Password</label>')
                    .append('<button class="btn btn-block elegant-color white-text" id="login">Login</button>')
                    .append('<a id="showRegister">Not a member? Sign up now.</a>');

                // Register User form
                jQuery(".nav-menu").append('<div class="card-panel register"></div>');
                jQuery("div.register")
                    .append('<h1>Register</h1><hr>')

                    .append('<input required type="text" name="username" id="username" placeholder="Enter your username..." />')
                    .append('<label for="username">Username</label>')

                    .append('<input required type="password" name="password" id="password" placeholder="Enter your password..." />')
                    .append('<label for="password">Password</label>')

                    .append('<input required type="email" name="email" id="email" placeholder="Enter your email..." />')
                    .append('<label for="email">Email</label>')

                    .append('<input required type="text" name="firstname" id="firstname" placeholder="Enter your first name..." />')
                    .append('<label for="firstname">First Name</label>')

                    .append('<input required type="text" name="lastname" id="lastname" placeholder="Enter your last name..." />')
                    .append('<label for="lastname">Last Name</label>')
                    //meta  
                    .append('<input required type="tel" name="phone" id="phone" placeholder="Enter your phone number..." />')
                    .append('<label for="phone">Phone Number</label>')
                    //meta  
                    .append('<select required name="language" id="language"></select>')
                    .append('<label for="language">Language</label>')
                    //meta  
                    .append('<select required name="country" id="country"></select>')
                    .append('<label for="country">Country</label>')
                    //meta  
                    .append('<select required name="interest" id="interest"></select>')
                    .append('<label for="interest">Interest</label>')
                    //meta  
                    .append('<select required name="expertise" id="expertise"></select>')
                    .append('<label for="expertise">Expertise</label>')

                    .append('<button class="btn btn-block elegant-color white-text" id="register">Register</button>')
                    
                    .append('<a id="showLogin">Already a member? Login now.</a>').hide();

                jQuery('div.register select#language')
                    .append('<option selected disabled>Select Language</option>')
                    .append('<option value="en">English</option>')
                    .append('<option value="bg">Bulgarian</option>')
                    .append('<option value="cs">Czech</option>')
                    .append('<option value="ro">Romanian</option>')
                    .append('<option value="tr">Turkish</option>')
                    .append('<option value="uk">Ukrainian</option>');

                jQuery('div.register select#country')
                    .append('<option selected disabled>Choose a country</option>')
                    .append('<option value="ir">Ireland</option>')
                    .append('<option value="en">United Kingdom</option>')
                    .append('<option value="bg">Bulgaria</option>')
                    .append('<option value="cs">Czech Republic</option>')
                    .append('<option value="ro">Romania</option>')
                    .append('<option value="tr">Turkey</option>')
                    .append('<option value="uk">Ukraine</option>');

                jQuery('div.register select#interest')
                    .append('<option selected disabled>Select area of interest</option>')
                    .append('<option value="Air Tightness">Air Tightness</option>')
                    .append('<option value="Solar">Solar</option>')
                    .append('<option value="Glazing">Glazing</option>')
                    .append('<option value="Passive House">Passive House</option>')
                    .append('<option value="Timber Frame">Timber Frame</option>')
                    .append('<option value="Ventilation">Ventilation</option>');

                jQuery('div.register select#expertise')
                    .append('<option selected disabled>Select area of expertise</option>')
                    .append('<option value="Air Tightness">Air Tightness</option>')
                    .append('<option value="Solar">Solar</option>')
                    .append('<option value="Glazing">Glazing</option>')
                    .append('<option value="Passive House">Passive House</option>')
                    .append('<option value="Timber Frame">Timber Frame</option>')
                    .append('<option value="Ventilation">Ventilation</option>');
                
                jQuery("a#showRegister").on('click', function(){
                    jQuery("div.login").hide();
                    jQuery("div.register").show();
                });
                jQuery("a#showLogin").on('click', function(){
                    jQuery("div.login").show();
                    jQuery("div.register").hide();
                });
            }

            // Click login button
            jQuery("#login").click(function(){

                var username = jQuery(".login #username").val();
                var password = jQuery(".login #password").val();

                // if the data is filled
                if(username != "" && password != ""){
                    jQuery.ajax({
                        type: "POST",
                        url:"http://www.train-to-nzeb-app.com/api/get_nonce/?controller=user&method=generate_auth_cookie",
                        crossDomain: true,
                        dataType: 'jsonp',
                        cache: false,
                        success: function(data){

                            var nonce = data.nonce;
                            var dataString = "nonce="+nonce+"&username="+username+"&password="+password+"&insecure=cool";

                            jQuery.ajax({
                                type: "POST",
                                url: "http://www.train-to-nzeb-app.com/api/user/generate_auth_cookie/?",
                                data: dataString,
                                crossDomain: true,
                                cache: false,
                                success: function(data){
                                    if(data.status == "ok"){
                                        localStorage.setItem("user_id", data.user.id)
                                        document.cookie = data.cookie;
                                        location.href = "./index.html";
                                    } else if(data.status == "error"){ 
                                        jQuery("div.alert").detach();
                                        jQuery("#login").before("<div class='alert alert-danger'>Invalid username and/or password</div>");
                                    }
                                },
                                error: function(x,e){ 

                                    jQuery("div.alert").detach();
                                    jQuery("#login").before("<div class='alert alert-danger'>Invalid username and/or password</div>");

                                    if (x.status == 0) {
                                        console.warn('You are offline! \nPlease Check Your Network.');
                                    } else if (x.status == 404) {
                                        console.warn('Requested URL not found \n Username and/or email is incorrect.');
                                    } else if (x.status == 500) {
                                        console.warn('Internel Server Error.');
                                    } else if (e == 'parsererror') {
                                        console.warn('Error.\nParsing JSON Request failed.');
                                    } else if (e == 'timeout') {
                                        console.warn('Request Time out.');
                                    } else {
                                        console.warn('Unknown Error.\n' + x.responseText);
                                    }
                                }
                            })
                        },
                        error: function(data){
                            jQuery("div.alert").detach();
                            jQuery("#login").before("<div class='alert alert-danger'>Unknown login error, try again.</div>");
                        }
                    });
                } else {
                    jQuery("div.alert").detach();
                    jQuery("#login").before("<div class='alert alert-danger'>Fill in your correct username and password</div>");
                }
            });

            // Click register button
            jQuery("#register").click(function(){

                var email = jQuery(".register #email").val();
                var username = jQuery(".register #username").val();
                var password = jQuery(".register #password").val();
                var first_name = jQuery(".register #firstname").val();
                var last_name = jQuery(".register #lastname").val();
                // meta data
                var phone = jQuery(".register #phone").val();
                var language = jQuery(".register #language").val();
                var country = jQuery(".register #country").val();
                var interest = jQuery(".register #interest").val();
                var expertise = jQuery(".register #expertise").val();

                // if all these fields have been filled, continue
                if(email != '' && username != '' && password != '' && first_name != '' && last_name != '' && 
                phone != '' && language != '' && country != '' && interest != '' && expertise != ''){

                    jQuery.ajax({
                        type: "POST",
                        url:"http://www.train-to-nzeb-app.com/api/get_nonce/?controller=user&method=register",
                        crossDomain: true,
                        dataType: 'jsonp',
                        cache: false,
                        success: function(data){

                            var fullName = first_name + '_' + last_name;
                            var nonce = data.nonce;
                            var dataString = "display_name="+fullName+"&email="+email+"&username="+username+"&user_pass="+password+"&nonce="+nonce+"&insecure=cool";
                            dataString += "&first_name="+first_name+"&last_name="+last_name;
                            
                            jQuery.ajax({
                                type: "POST",
                                url:"http://www.train-to-nzeb-app.com/api/user/register",
                                dataType: "jsonp",
                                data: dataString,
                                crossDomain: true,
                                cache: false,
                                success: function(data){
                                    if(data.status == "ok"){
                                        document.cookie = data.cookie;
                                        localStorage.setItem("user_id", data.user_id)
                                        var the_user_id = data.user_id;

                                        jQuery.ajax({
                                            url: 'http://www.train-to-nzeb-app.com/wp-admin/admin-ajax.php',
                                            type: 'POST',
                                            data: {
                                                action: 'iwhq_new_user_meta',
                                                user_id: the_user_id,
                                                phone: phone,
                                                language: language,
                                                country: country,
                                                interest: interest,
                                                expertise: expertise,
                                                dataType: 'jsonp',
                                                crossDomain: true
                                            },
                                            success: function (response) {console.log("Getting a response, server success");
                                                location.href = "./index.html";
                                            },
                                            error: function (jqXHR, textStatus, errorThrown) {
                                                if (textStatus === "timeout") {
                                                    console.warn("Call has timed out"); //Handle the timeout
                                                } else {
                                                    console.warn("Another error was returned" + errorThrown); //Handle other error type
                                                }
                                            }
                                        })
                                    } else {
                                        jQuery("div.alert").detach();
                                        jQuery("#register").before("<div class='alert alert-danger'>We couldn't register your information, please try again. Make sure all fields are filled and have the correct information.</div>");
                                    }

                                    
                                },
                                error:function(x,e) {
                                    if (x.status == 0) {
                                        console.warn('You are offline!!\n Please Check Your Network.');
                                    } else if (x.status == 404) {
                                        console.warn('Requested URL not found.');
                                    } else if (x.status == 500) {
                                        console.warn('Internel Server Error.');
                                    } else if (e == 'parsererror') {
                                        console.warn('Error.\nParsing JSON Request failed.');
                                    } else if (e == 'timeout') {
                                        console.warn('Request Time out.');
                                    } else {
                                        console.warn('Unknown Error.\n' + x.responseText);
                                    }
                                }
                            });
                        },
                        error: function(data){
                            console.log('error: ' + data);
                        }
                    });
                    // otherwise, tell the user
                } else {
                    jQuery("div.alert").detach();
                    jQuery("#register").before("<div class='alert alert-danger'>Please fill in every field</div>");
                }
            });
        });

    </script>

</body>

</html>