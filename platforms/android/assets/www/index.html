<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title>Concept App</title>

    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/mdb.min.css" rel="stylesheet">
    <link href="./css/styles.css" rel="stylesheet">

</head>

<body class="container green lighten-2">

    <div class="row">
        <div class="card-panel col-sm-12 index">
        </div>
    </div>

    <script type="text/javascript" src="cordova.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/mdb.min.js"></script>
    <script type="text/javascript" src="./js/functions.js"></script>

    <script type="text/javascript">
        jQuery(document).ready(function(){

            // if the cookie exists, the user is logged in
            if(document.cookie){
                console.log("Cookie");
                jQuery("div.index")
                    .append('<h1>NZEB Home</h1><hr>')
                    .append('<div>Welcome <span></span> to the Near-Zero Energy Building app. Take our training courses now!</div>')
                    .append("<a onclick='setContentView(\"Material\")' class='btn btn-block green white-text' href='./training-hub.html'>Training Hub</a>");
                jQuery("div.row").before('<a class="btn btn-sm white green-text" id="logout" href="./index.html">Logout</a>');

                jQuery("a#logout").on("click", function(){
                    document.cookie += ";expires=Thu, 01 Jan 1970 00:00:00 UTC;";
                    localStorage.setItem("user_id", "");
                });

                // TODO - get_user_meta user's name for welcome message after logging in

            // if the cookie does not exist, the user must log in
            } else if(!document.cookie){
                console.log("No cookie");

                // Login User form
                jQuery("div.index").append('<div class="login"></div>');
                jQuery("div.login")
                    .append('<h1>NZEB Login</h1><hr>')
                    .append('<label for="username">Username:</label>')
                    .append('<input type="text" name="username" id="username" placeholder="Enter your username..." />')
                    .append('<label for="password">Password:</label>')
                    .append('<input type="password" name="password" id="password" placeholder="Enter your password..." />')
                    .append('<button class="btn btn-block green white-text" id="login">Login</button>')
                    .append('<a id="showRegister">Not a member? Sign up now.</a>');

                // Register User form
                jQuery("div.index").append('<div class="register"></div>');
                jQuery("div.register")
                    .append('<h1>NZEB Register</h1><hr>')
                    .append('<label for="username">Username:</label>')
                    .append('<input type="text" name="username" id="username" placeholder="Enter your username..." />')
                    .append('<label for="password">Password:</label>')
                    .append('<input type="password" name="password" id="password" placeholder="Enter your password..." />')
                    .append('<label for="email">Email:</label>')
                    .append('<input type="email" name="email" id="email" placeholder="Enter your email..." />')
                    .append('<label for="firstname">First Name:</label>')
                    .append('<input type="text" name="firstname" id="firstname" placeholder="Enter your first name..." />')
                    .append('<label for="lastname">Last Name:</label>')
                    .append('<input type="text" name="lastname" id="lastname" placeholder="Enter your last name..." />')
                    .append('<label for="displayname">Display Name:</label>')
                    .append('<input type="text" name="displayname" id="displayname" placeholder="Enter your display name..." />')
                    .append('<button class="btn btn-block green white-text" id="register">Register</button>')
                    .append('<a id="showLogin">Already a member? Login now.</a>').hide();

                
                
                
                jQuery("a#showRegister").on('click', function(){
                    jQuery("div.login").hide();
                    jQuery("div.register").show();
                });
                jQuery("a#showLogin").on('click', function(){
                    jQuery("div.login").show();
                    jQuery("div.register").hide();
                });
            }

            // Click login button
            jQuery("#login").click(function(){

                var username = jQuery(".login #username").val();
                var password = jQuery(".login #password").val();

                jQuery.ajax({
                    type: "POST",
                    url:"http://www.webhq.ie/api/get_nonce/?controller=user&method=generate_auth_cookie",
                    crossDomain: true,
                    dataType: 'jsonp',
                    cache: false,
                    success: function(data){

                        var nonce = data.nonce;
                        var dataString = "nonce="+nonce+"&username="+username+"&password="+password+"&insecure=cool";

                        jQuery.ajax({
                            type: "POST",
                            url: "http://www.webhq.ie/api/user/generate_auth_cookie/?",
                            data: dataString,
                            crossDomain: true,
                            cache: false,
                            success: function(data){
                                if(data.status == "ok"){
                                    localStorage.setItem("user_id", data.user.id)
                                    document.cookie = data.cookie;
                                    location.href = "./index.html";
                                } else if(data.status == "error"){ 
                                    jQuery("div.alert").detach();
                                    jQuery("div.login").prepend("<div class='alert alert-danger'>Invalid Username and/or Password details</div>");
                                }
                            },
                            error: function(x,e){ 
                                if (x.status == 0) {
                                    alert('You are offline!!\n Please Check Your Network.');
                                } else if (x.status == 404) {
                                    //alert('Requested URL not found \n Username and/or email is incorrect.');
                                    jQuery("div.alert").detach();
                                    jQuery("div.login").prepend("<div class='alert alert-danger'>Invalid Username and/or Password details</div>");
                                } else if (x.status == 500) {
                                    alert('Internel Server Error.');
                                } else if (e == 'parsererror') {
                                    alert('Error.\nParsing JSON Request failed.');
                                } else if (e == 'timeout') {
                                    alert('Request Time out.');
                                } else {
                                    alert('Unknown Error.\n' + x.responseText);
                                }
                            }
                        })
                    },
                    error: function(data){
                        alert("error");
                    }
                });
            });

            // Click register button
            jQuery("#register").click(function(){

                var display_name = jQuery(".register #displayname").val();
                var email = jQuery(".register #email").val();
                var username = jQuery(".register #username").val();
                var password = jQuery(".register #password").val();
                var first_name = jQuery(".register #firstname").val();
                var last_name = jQuery(".register #lastname").val();

                jQuery.ajax({
                    type: "POST",
                    url:"http://www.webhq.ie/api/get_nonce/?controller=user&method=register",
                    crossDomain: true,
                    dataType: 'jsonp',
                    cache: false,
                    success: function(data){

                        var nonce = data.nonce;
                        var dataString = "display_name="+display_name+"&email="+email+"&username="+username+"&user_pass="+password+"&nonce="+nonce+"&insecure=cool";
                        dataString += "&first_name="+first_name+"&last_name="+last_name;
                        
                        jQuery.ajax({
                            type: "POST",
                            url:"http://www.webhq.ie/api/user/register",
                            dataType: "jsonp",
                            data: dataString,
                            crossDomain: true,
                            cache: false,
                            success: function(data){

                                document.cookie = data.cookie;
                                location.href = "./index.html";
                            },
                            error:function(x,e) {
                                if (x.status == 0) {
                                    alert('You are offline!!\n Please Check Your Network.');
                                } else if (x.status == 404) {
                                    alert('Requested URL not found.');
                                } else if (x.status == 500) {
                                    alert('Internel Server Error.');
                                } else if (e == 'parsererror') {
                                    alert('Error.\nParsing JSON Request failed.');
                                } else if (e == 'timeout') {
                                    alert('Request Time out.');
                                } else {
                                    alert('Unknown Error.\n' + x.responseText);
                                }
                            }
                        });
                    },
                    error: function(data){
                        console.log(data);
                    }
                });
            });
        });

    </script>

</body>

</html>