<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title>Train to NZEB</title>

    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/mdb.min.css" rel="stylesheet">
    <link href="./css/styles.css" rel="stylesheet">

</head>

<body class="container elegant-color-dark">

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="./index.html">Home</a>
        <a href="./about.html">About NZEB</a>
        <a href="./training-hub.html">Training</a>
        <a href="#">Search Members</a>
        <a href="./links.html">Links</a>
        <a id="logout" href="./index.html">Logout</a>
    </div>

    <div class="row">

        <div class="card-panel menu-top">
            <div class="col-xs-2 menu-icon" onclick="openNav()"><span class="glyphicons glyphicons-group"></span></div>
            <div class="col-xs-8"><a href="./index.html"><img src="./img/train-to-nzeb.png" alt="NZEB"/></a></div>
            <div class="col-xs-2 profile"><a href="./profile.html"><img src="./img/profile.png" alt="Go to profile"/></a></div>
        </div>

        <img src="./img/nzeb-bg.png" alt="NZEB Background Image" />

        <div class="nav-menu">
            <div class="card-panel col-sm-12 nav">&#xE044;<a href="./about.html">About NZEB</a></div>
            <div class="card-panel col-sm-12 nav"><a href="./training-hub.html">Training</a></div>
            <div class="card-panel col-sm-12 nav"><a href="#">Search Members Database</a></div>
            <div class="card-panel col-sm-12 nav"><a href="./links.html">Links</a></div>
            <div class="card-panel amber col-sm-12 nav-bottom"><a href="./training-content.html"></a></div>
        </div>

    </div>

    <script type="text/javascript" src="cordova.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/mdb.min.js"></script>
    <script type="text/javascript" src="./js/functions.js"></script>

    <script type="text/javascript">

        jQuery(document).ready(function(){

            // if the cookie exists, the user is logged in
            if(document.cookie){
                console.log("Cookie");

                if(getCoursesCompleted() == 0){
                    jQuery(".nav-bottom a").text("Begin Training");
                } else {
                    jQuery(".nav-bottom a").text("Continue Training");
                }
                
                jQuery("a#logout").on("click", function(){
                    document.cookie += ";expires=Thu, 01 Jan 1970 00:00:00 UTC;";
                    localStorage.setItem("user_id", "");
                });

                // TODO? - get_user_meta user's name for welcome message after logging in

            // if the cookie does not exist, the user must log in
            } else if(!document.cookie){
                console.log("No cookie");

                // hide items only to be seen when logged in
                jQuery(".nav-menu").children().hide();
                jQuery(".menu-icon").text("");
                jQuery(".profile a").hide();

                // Login User form
                jQuery(".nav-menu").append('<div class="card-panel login"></div>');
                jQuery("div.login")
                    .append('<h1>Login</h1><hr>')
                    .append('<input type="text" name="username" id="username" placeholder="Enter your username..." />')
                    .append('<label for="username">Username</label>')
                    .append('<input type="password" name="password" id="password" placeholder="Enter your password..." />')
                    .append('<label for="password">Password</label>')
                    .append('<button class="btn btn-block elegant-color white-text" id="login">Login</button>')
                    .append('<a id="showRegister">Not a member? Sign up now.</a>');

                // Register User form
                jQuery(".nav-menu").append('<div class="card-panel register"></div>');
                jQuery("div.register")
                    .append('<h1>Register</h1><hr>')
                    .append('<input type="text" name="username" id="username" placeholder="Enter your username..." />')
                    .append('<label for="username">Username</label>')
                    .append('<input type="password" name="password" id="password" placeholder="Enter your password..." />')
                    .append('<label for="password">Password</label>')
                    .append('<input type="email" name="email" id="email" placeholder="Enter your email..." />')
                    .append('<label for="email">Email</label>')
                    .append('<input type="text" name="firstname" id="firstname" placeholder="Enter your first name..." />')
                    .append('<label for="firstname">First Name</label>')
                    .append('<input type="text" name="lastname" id="lastname" placeholder="Enter your last name..." />')
                    .append('<label for="lastname">Last Name</label>')
                    .append('<input type="text" name="displayname" id="displayname" placeholder="Enter your display name..." />')
                    .append('<label for="displayname">Display Name</label>')
                    .append('<button class="btn btn-block elegant-color white-text" id="register">Register</button>')
                    .append('<a id="showLogin">Already a member? Login now.</a>').hide();
                
                jQuery("a#showRegister").on('click', function(){
                    jQuery("div.login").hide();
                    jQuery("div.register").show();
                });
                jQuery("a#showLogin").on('click', function(){
                    jQuery("div.login").show();
                    jQuery("div.register").hide();
                });
            }

            // Click login button
            jQuery("#login").click(function(){

                var username = jQuery(".login #username").val();
                var password = jQuery(".login #password").val();

                jQuery.ajax({
                    type: "POST",
                    url:"http://www.webhq.ie/api/get_nonce/?controller=user&method=generate_auth_cookie",
                    crossDomain: true,
                    dataType: 'jsonp',
                    cache: false,
                    success: function(data){

                        var nonce = data.nonce;
                        var dataString = "nonce="+nonce+"&username="+username+"&password="+password+"&insecure=cool";

                        jQuery.ajax({
                            type: "POST",
                            url: "http://www.webhq.ie/api/user/generate_auth_cookie/?",
                            data: dataString,
                            crossDomain: true,
                            cache: false,
                            success: function(data){
                                if(data.status == "ok"){
                                    localStorage.setItem("user_id", data.user.id)
                                    document.cookie = data.cookie;
                                    location.href = "./index.html";
                                } else if(data.status == "error"){ 
                                    jQuery("div.alert").detach();
                                    jQuery("#login").before("<div class='alert alert-danger'>Invalid Username and/or Password</div>");
                                }
                            },
                            error: function(x,e){ 
                                if (x.status == 0) {
                                    alert('You are offline!!\n Please Check Your Network.');
                                } else if (x.status == 404) {
                                    //alert('Requested URL not found \n Username and/or email is incorrect.');
                                    jQuery("div.alert").detach();
                                    jQuery("#login").before("<div class='alert alert-danger'>Invalid Username and/or Password</div>");
                                } else if (x.status == 500) {
                                    alert('Internel Server Error.');
                                } else if (e == 'parsererror') {
                                    alert('Error.\nParsing JSON Request failed.');
                                } else if (e == 'timeout') {
                                    alert('Request Time out.');
                                } else {
                                    alert('Unknown Error.\n' + x.responseText);
                                }
                            }
                        })
                    },
                    error: function(data){
                        alert("error");
                    }
                });
            });

            // Click register button
            jQuery("#register").click(function(){

                var display_name = jQuery(".register #displayname").val();
                var email = jQuery(".register #email").val();
                var username = jQuery(".register #username").val();
                var password = jQuery(".register #password").val();
                var first_name = jQuery(".register #firstname").val();
                var last_name = jQuery(".register #lastname").val();

                jQuery.ajax({
                    type: "POST",
                    url:"http://www.webhq.ie/api/get_nonce/?controller=user&method=register",
                    crossDomain: true,
                    dataType: 'jsonp',
                    cache: false,
                    success: function(data){

                        var nonce = data.nonce;
                        var dataString = "display_name="+display_name+"&email="+email+"&username="+username+"&user_pass="+password+"&nonce="+nonce+"&insecure=cool";
                        dataString += "&first_name="+first_name+"&last_name="+last_name;
                        
                        jQuery.ajax({
                            type: "POST",
                            url:"http://www.webhq.ie/api/user/register",
                            dataType: "jsonp",
                            data: dataString,
                            crossDomain: true,
                            cache: false,
                            success: function(data){
                                if(data.status == "ok"){
                                    document.cookie = data.cookie;
                                    location.href = "./index.html";
                                } else {
                                    jQuery("div.alert").detach();
                                    jQuery("#register").before("<div class='alert alert-danger'>Please fill in every field</div>");
                                }

                                
                            },
                            error:function(x,e) {
                                if (x.status == 0) {
                                    alert('You are offline!!\n Please Check Your Network.');
                                } else if (x.status == 404) {
                                    alert('Requested URL not found.');
                                } else if (x.status == 500) {
                                    alert('Internel Server Error.');
                                } else if (e == 'parsererror') {
                                    alert('Error.\nParsing JSON Request failed.');
                                } else if (e == 'timeout') {
                                    alert('Request Time out.');
                                } else {
                                    alert('Unknown Error.\n' + x.responseText);
                                }
                            }
                        });
                    },
                    error: function(data){
                        console.log(data);
                    }
                });
            });
        });

    </script>

</body>

</html>